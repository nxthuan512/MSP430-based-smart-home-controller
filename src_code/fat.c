#include <string.h>

#include "msp430f5438.h"
#include "MMC.h"
#include "fat.h"
#include "stdio.h"

// ======================================================================
// Initialize the card function... probably needs a lower level call  
// ======================================================================
void init_fat( FAT16_t *FAT, u8 *sd_buffer) 
{ 
    u8 i;
    u16 j;
    u8 fat16_bootsector[512] = {	0xEB,	0x3C,	0x90,	0x4D,	0x53,	0x44,	0x4F,	0x53,	
									0x35,	0x2E,	0x30,	0x00,	0x02,	0x20,	0x02,	0x00,
									0x02,	0x00,	0x02,	0x00,	0x00,	0xF8,	0xE7,	0x00,	
									0x3F,	0x00,	0xFF,	0x00,	0x00,	0x00,	0x00,	0x00,
									0x00,	0xD0,	0x1C,	0x00,	0x80,	0x00,	0x29,	0x98,	
									0x00,	0xCF,	0x96,	0x4E,	0x4F,	0x20,	0x4E,	0x41,
									0x4D,	0x45,	0x20,	0x20,	0x20,	0x20,	0x46,	0x41,	
									0x54,	0x31,	0x36,	0x20,	0x20,	0x20,	0x33,	0xC9,
									0x8E,	0xD1,	0xBC,	0xF0,	0x7B,	0x8E,	0xD9,	0xB8,	
									0x00,	0x20,	0x8E,	0xC0,	0xFC,	0xBD,	0x00,	0x7C,
									0x38,	0x4E,	0x24,	0x7D,	0x24,	0x8B,	0xC1,	0x99,	
									0xE8,	0x3C,	0x01,	0x72,	0x1C,	0x83,	0xEB,	0x3A,
									0x66,	0xA1,	0x1C,	0x7C,	0x26,	0x66,	0x3B,	0x07,	
									0x26,	0x8A,	0x57,	0xFC,	0x75,	0x06,	0x80,	0xCA,
									0x02,	0x88,	0x56,	0x02,	0x80,	0xC3,	0x10,	0x73,	
									0xEB,	0x33,	0xC9,	0x8A,	0x46,	0x10,	0x98,	0xF7,
									0x66,	0x16,	0x03,	0x46,	0x1C,	0x13,	0x56,	0x1E,	
									0x03,	0x46,	0x0E,	0x13,	0xD1,	0x8B,	0x76,	0x11,
									0x60,	0x89,	0x46,	0xFC,	0x89,	0x56,	0xFE,	0xB8,	
									0x20,	0x00,	0xF7,	0xE6,	0x8B,	0x5E,	0x0B,	0x03,
									0xC3,	0x48,	0xF7,	0xF3,	0x01,	0x46,	0xFC,	0x11,	
									0x4E,	0xFE,	0x61,	0xBF,	0x00,	0x00,	0xE8,	0xE6,
									0x00,	0x72,	0x39,	0x26,	0x38,	0x2D,	0x74,	0x17,	
									0x60,	0xB1,	0x0B,	0xBE,	0xA1,	0x7D,	0xF3,	0xA6,
									0x61,	0x74,	0x32,	0x4E,	0x74,	0x09,	0x83,	0xC7,	
									0x20,	0x3B,	0xFB,	0x72,	0xE6,	0xEB,	0xDC,	0xA0,
									0xFB,	0x7D,	0xB4,	0x7D,	0x8B,	0xF0,	0xAC,	0x98,	
									0x40,	0x74,	0x0C,	0x48,	0x74,	0x13,	0xB4,	0x0E,
									0xBB,	0x07,	0x00,	0xCD,	0x10,	0xEB,	0xEF,	0xA0,	
									0xFD,	0x7D,	0xEB,	0xE6,	0xA0,	0xFC,	0x7D,	0xEB,
									0xE1,	0xCD,	0x16,	0xCD,	0x19,	0x26,	0x8B,	0x55,	
									0x1A,	0x52,	0xB0,	0x01,	0xBB,	0x00,	0x00,	0xE8,
									0x3B,	0x00,	0x72,	0xE8,	0x5B,	0x8A,	0x56,	0x24,	
									0xBE,	0x0B,	0x7C,	0x8B,	0xFC,	0xC7,	0x46,	0xF0,
									0x3D,	0x7D,	0xC7,	0x46,	0xF4,	0x29,	0x7D,	0x8C,	
									0xD9,	0x89,	0x4E,	0xF2,	0x89,	0x4E,	0xF6,	0xC6,
									0x06,	0x96,	0x7D,	0xCB,	0xEA,	0x03,	0x00,	0x00,	
									0x20,	0x0F,	0xB6,	0xC8,	0x66,	0x8B,	0x46,	0xF8,
									0x66,	0x03,	0x46,	0x1C,	0x66,	0x8B,	0xD0,	0x66,	
									0xC1,	0xEA,	0x10,	0xEB,	0x5E,	0x0F,	0xB6,	0xC8,
									0x4A,	0x4A,	0x8A,	0x46,	0x0D,	0x32,	0xE4,	0xF7,	
									0xE2,	0x03,	0x46,	0xFC,	0x13,	0x56,	0xFE,	0xEB,
									0x4A,	0x52,	0x50,	0x06,	0x53,	0x6A,	0x01,	0x6A,	
									0x10,	0x91,	0x8B,	0x46,	0x18,	0x96,	0x92,	0x33,
									0xD2,	0xF7,	0xF6,	0x91,	0xF7,	0xF6,	0x42,	0x87,	
									0xCA,	0xF7,	0x76,	0x1A,	0x8A,	0xF2,	0x8A,	0xE8,
									0xC0,	0xCC,	0x02,	0x0A,	0xCC,	0xB8,	0x01,	0x02,	
									0x80,	0x7E,	0x02,	0x0E,	0x75,	0x04,	0xB4,	0x42,
									0x8B,	0xF4,	0x8A,	0x56,	0x24,	0xCD,	0x13,	0x61,	
									0x61,	0x72,	0x0B,	0x40,	0x75,	0x01,	0x42,	0x03,
									0x5E,	0x0B,	0x49,	0x75,	0x06,	0xF8,	0xC3,	0x41,	
									0xBB,	0x00,	0x00,	0x60,	0x66,	0x6A,	0x00,	0xEB,
									0xB0,	0x42,	0x4F,	0x4F,	0x54,	0x4D,	0x47,	0x52,	
									0x20,	0x20,	0x20,	0x20,	0x0D,	0x0A,	0x52,	0x65,	
									0x6D,	0x6F,	0x76,	0x65,	0x20,	0x64,	0x69,	0x73,	
									0x6B,	0x73,	0x20,	0x6F,	0x72,	0x20,	0x6F,	0x74,	
									0x68,	0x65,	0x72,	0x20,	0x6D,	0x65,	0x64,	0x69,	
									0x61,	0x2E,	0xFF,	0x0D,	0x0A,	0x44,	0x69,	0x73,	
									0x6B,	0x20,	0x65,	0x72,	0x72,	0x6F,	0x72,	0xFF,	
									0x0D,	0x0A,	0x50,	0x72,	0x65,	0x73,	0x73,	0x20,	
									0x61,	0x6E,	0x79,	0x20,	0x6B,	0x65,	0x79,	0x20,	
									0x74,	0x6F,	0x20,	0x72,	0x65,	0x73,	0x74,	0x61,	
									0x72,	0x74,	0x0D,	0x0A,	0x00,	0x00,	0x00,	0x00,	
									0x00,	0x00,	0x00,	0xAC,	0xCB,	0xD8,	0x55,	0xAA  };
    
    char fat_label[] = {	0x46, 0x45, 0x54, 0x45, 0x4c, 0x5f, 0x48, 0x43, 
    						0x4d, 0x55, 0x53, 0x08, 0x00, 0x00, 0x00, 0x00,
    						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2e, 0x6c, 
    						0x7a, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    u8 fat_label_length = strlen(fat_label);
    
    unsigned long sdcard_address = 0; 	
 	// Setup Boot Sector
 	mmcWriteSector(sdcard_address, fat16_bootsector);       
 	mmcReadSector(sdcard_address, sd_buffer);
 	
    FAT->P_Start = 0;
    FAT->Bytes_Sector 	= (sd_buffer[12] << 8) + sd_buffer[11];
    FAT->Secs_Cluster 	= sd_buffer[13];                    				// set the number of sectors per cluster 
    FAT->Num_Fats 		= sd_buffer[16];                        			// record the number of Fats 
    FAT->Secs_Fat 		= (sd_buffer[23] << 8) + sd_buffer[22]; 			// sets the Sectors per FAT 
    FAT->Res_Secs 		= (sd_buffer[15] << 8) + sd_buffer[14];  			// Sets the number of reserved Sectors 
    FAT->Fat_Start[0] 	= FAT->P_Start + FAT->Res_Secs;       				// Set first FAT table location 
            
    // Dinh dia chi va Xoa bang FAT
    for (i = 0; i < FAT->Num_Fats && i < MAX_FATS; ++i)
    {
    	FAT->Fat_Start[i] = FAT->P_Start + FAT->Secs_Fat * i + FAT->Res_Secs;
    	
    	sd_buffer[0] = 0xF8; sd_buffer[1] = 0xFF;
	    sd_buffer[2] = 0xFF; sd_buffer[3] = 0xFF;
    	for (j = 4; j < 512; ++j)
    		sd_buffer[j] = 0x00;
    	mmcWriteSector(FAT->Fat_Start[i], sd_buffer);
    }
         
    FAT->Root_Start = FAT->P_Start + FAT->Res_Secs +  FAT->Secs_Fat * FAT->Num_Fats;
    
    // Ghi label cho SDCard
    mmcReadSector(FAT->Root_Start, sd_buffer);
    for (i = 0; i < fat_label_length; ++i)
    	*(sd_buffer + i) = fat_label[i];
    mmcWriteSector(FAT->Root_Start, sd_buffer);
}

// ======================================================================================  
// Funtion: open_file 
// 		file_number: gtri thu tu file (0, 1, 2, ...)
// ======================================================================================
void open_file( FILE_t *FILE, FAT16_t *FAT, u8 *sd_buffer, 
				u8 *file_name, u8 *date_time, u8 file_number, u16 cluster) 
{ 
	u8  i = 0;  
    u8 	j = 0;
	u16 offset = 0;
	u8 	file_name_length = strlen(file_name);
    
    // ------------------ FILE --------------------
    // Buoc 0: gan gia tri mang File_name = 0x20
    for (i = 0; i < 11; ++i)
    	FILE->File_Name[i] = 0x20;
    
    i = 0;
    // Buoc 1: luu ten file vao FILE
    do
    {
    	FILE->File_Name[i] = file_name[i];
    	++i;
    } 
    while (file_name[i] != '.' && i < 8);
    
	++i;
    for (j = 8; j < 11; ++j, ++i)
    {
    	if ((file_name[i] > 96) && (file_name[i] < 123))	FILE->File_Name[j] = file_name[i] - 32;
    	else										   		FILE->File_Name[j] = file_name[i];	
    }	
    
    // Buoc 2: luu StartCluster va StartSector
    FILE->start_cluster = cluster;
    FILE->Fat_OpenCluster = (FAT->Root_Start / 32) + (FILE->start_cluster - 1);
    FILE->Fat_OpenSec = FAT->Root_Start + (FILE->start_cluster - 1) * 32;
    // Buoc 3: cac thong so con lai
    for (i = 0; i < 4; ++i)
    	FILE->Date_Time[i] = date_time[i];
    FILE->file_size = 0x00;
    FILE->file_number = file_number;
    
    // ------------------ FAT ------------------------
    // Ghi vao bang FAT
    for(j = 0; j < FAT->Num_Fats; ++j) 
    {
	    mmcReadSector(FAT->Fat_Start[j], sd_buffer);
	    i = 0;
	    while (sd_buffer[i++] != 0x00);
	    sd_buffer[i-1] = 0xFF;
	    sd_buffer[i] = 0xFF;
	    mmcWriteSector(FAT->Fat_Start[j], sd_buffer);
    }
    
    // ----------------- DIRECTORY ------------------
    // Ghi vao bang Director
    mmcReadSector(FAT->Root_Start, sd_buffer);
    
    // Buoc 1: luu ten file
    offset += 32 * (file_number + 1);	
    for (i = offset; i < offset + 32; ++i)					    	sd_buffer[i] = 0x00;
    for (i = offset, j = 0; i < offset + 12; ++i, ++j)		    	sd_buffer[i] = FILE->File_Name[j];
    // luu attributes
    sd_buffer[i - 1] = 0x20;
    
    // Buoc 2: luu ngay thang nam
    offset += 22;
    for (i = offset, j = 0; i < offset + 4; ++i, ++j)		    	sd_buffer[i] = FILE->Date_Time[j];
    
    // Buoc 3: tao Start Cluster, bat dau o cluster ke tiep (cluster 2)
    offset += 4;
    sd_buffer[offset] 	  = (u8)(cluster);
    sd_buffer[offset + 1] = (u8)(cluster >> 8);
    
    // Ghi sd_buffer vao vung nho
	mmcWriteSector(FAT->Root_Start, sd_buffer);	
}
// ============================================================================= 
// Funtion: read_file 
// ============================================================================== 
void read_file( FILE_t *FILE, u8 *sd_buffer) 
{  
    mmcReadSector(FILE->Fat_OpenSec, sd_buffer);
} 

// ================================================================================ 
// Funtion: write_file  
//
// write_pos: ghi vao bytes thu may tinh tu vi tri dau cua sector
// ================================================================================
void write_file( FILE_t *FILE, u8 *sd_buffer, char *write_data, u8 *write_data_length, u16 write_pos, u8 *date_time) 
{
	u16 i = 0;
//	u8 write_data_length = strlen(write_data);
	 
	mmcReadSector(FILE->Fat_OpenSec, sd_buffer);
	
	for (i = 0; i < *write_data_length; ++i)
		sd_buffer[i + write_pos] = write_data[i];
	 
    mmcWriteSector(FILE->Fat_OpenSec, sd_buffer); 
    
    // Cap nhat lai file size
    FILE->file_size += *write_data_length;
    for (i = 0; i < 4; ++i)
    	FILE->Date_Time[i] = date_time[i];     
}
    
// ================================================================================ 
// Funtion: close_file 
// 
// =================================================================================
void close_file( FILE_t *FILE, FAT16_t *FAT, u8 *sd_buffer)
{
	u8 i = 0;
	u8 j = 0;
	u16 temp = 0;
	u16 offset = 0;
// ---------- Thay doi bang FAT --------------- 
    mmcReadSector(FAT->Root_Start, sd_buffer);
    offset = FILE->file_number * 32;
    
    // Thay doi ngay gio cap nhat
    for (i = 54; i < 58; ++i)
    	sd_buffer[i + offset] = FILE->Date_Time[j++];
    // Thay doi kich co file
    temp = FILE->file_size;
    for (i = 60; i < 64; ++i)
    {
    	sd_buffer[i + offset] = (u8)(temp);
    	temp >>= 8;
    }
    mmcWriteSector(FAT->Root_Start, sd_buffer);
}
